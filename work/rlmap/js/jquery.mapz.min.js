(function($){$.fn.mapz=function(options){var settings={'zoom':false,'createmaps':false,'mousewheel':false};if(options){$.extend(settings,options);}
var viewport=this.parent('.map-viewport');var map=this;var constraint=$(document.createElement('div')).addClass('mapz-constraint').css('position','absolute').appendTo(viewport);map.children(".level:first").addClass('current-level');createConstraint();if(settings.zoom){$(document).keydown(function(e){if(e.keyCode==38){zoom('in');return false;}else if(e.keyCode==40){zoom('out');return false;}});if(settings.mousewheel){map.bind('mousewheel',function(event,delta){var dir=delta>0?'in':'out';zoom(dir);return false;});}
if(settings.createmaps)createMaps();}
map.draggable({containment:constraint});function createMaps(){var htmlmap=viewport.children('map');var scale=1;var i=0;map.children('.level').each(function(){i++;if($(this).hasClass('current-level'))return;scale=$(this).width()/map.width();var newmap=$(document.createElement('map')).attr('name',map.attr('id')+'-map-'+i);htmlmap.children('area').each(function(){var newArea=$(this).clone();var coords=$(this).attr('coords').split(',');for(c in coords){coords[c]=Math.ceil(coords[c]*scale);}
newArea.attr('coords',coords).appendTo(newmap);});newmap.appendTo(viewport);$(this).attr('usemap','#'+map.attr('id')+'-map-'+i);});}
function createConstraint()
{constraint.css({left:-(map.width())+viewport.width(),top:-(map.height())+viewport.height(),width:2*map.width()-viewport.width(),height:2*map.height()-viewport.height()});if(map.position().left<constraint.position().left)map.css('left',constraint.position().left);if(map.position().top<constraint.position().top)map.css('top',constraint.position().top);}
function zoom(direction){var currentlvl=map.children(".current-level");switch(direction){case'in':if(map.children(".current-level").next().length==0)return;var targetlvl=currentlvl.next();break;case'out':if(map.children(".current-level").prev().length==0)return;var targetlvl=currentlvl.prev();break;}
var scale={'x':(targetlvl.height()-viewport.height())/(currentlvl.height()-viewport.height()),'y':(targetlvl.width()-viewport.width())/(currentlvl.width()-viewport.width())}
currentlvl.removeClass('current-level');targetlvl.addClass('current-level');var pos=map.position();map.css({left:pos.left*scale.x,top:pos.top*scale.y,width:targetlvl.width(),height:targetlvl.height()});createConstraint();}};})(jQuery);